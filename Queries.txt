------  MAX  --------
--1. Institutions com maior numero de obitos
select i.name, r.name, sum(hr.deaths) as 'TotalDeaths'
from institutions i join regions r on i.regionId = r.id
join healthRegistries hr on hr.institutionId = i.id
group by i.name, r.name
order by sum(hr.deaths) desc; DONE :)

--2. Regions com maior numero de obitos
select r.name, sum(hr.deaths) as 'TotalDeaths'
from institutions i join regions r on i.regionId = r.id
join healthRegistries hr on hr.institutionId = i.id
group by r.name
order by sum(hr.deaths) desc; DONE :)

--3. Institutions com maior numero de internamentos e duracao media de cada internamento
select i.name as 'Institution', r.name as 'Region', sum(hr.hospitalizations) as 'Total Hospitalizations', ifnull(round(avg(hr.daysofhospitalization / hr.hospitalizations), 1) || ' day/s', 0) as 'Average Hospitalization Time Per Case'
from institutions i join regions r on i.regionId = r.id
join healthRegistries hr on hr.institutionId = i.id
group by i.name, r.name
order by sum(hr.hospitalizations) desc, round(avg(hr.daysofhospitalization / hr.hospitalizations), 1) desc; DONE! :)

--4. Diagnostic Groups - total num de internamentos e obitos
select dg.description as 'Diagnosis Group', sum(hr.hospitalizations) as 'Total Hospitalizations Per Diagnostic Group', sum(hr.deaths) as 'Total Deaths Per Diagnosis Group'
from diagnosticGroups dg join healthRegistries hr on dg.id=hr.diagnosticgroupId
group by dg.description
order by sum(hr.hospitalizations) desc, sum(hr.deaths) desc;  DONE! :)

--5. morbilidade e mortalidade de cada AgeGroup para cada Diagnostic group
select dg.description, (ag.minimumAge || ' - ' || ag.maximumAge) as 'Age Range', sum(hr.hospitalizations) as 'Total Hospitalizations', sum(hr.deaths) as 'Total Deaths'
from healthRegistries hr join diagnosticGroups dg on hr.diagnosticGroupId = dg.id
join ageGroups ag on ag.id = hr.ageGroupId
group by dg.description, ag.minimumAge, ag.maximumAge
order by dg.description, ag.minimumAge;

--6. doenca mais grave (most deaths) per age group
with deathsPerGroupAndDoenca as (select dg.description, ag.minimumAge, ag.maximumAge, sum(hr.deaths) as 'TotalDeaths'
from healthRegistries hr join diagnosticGroups dg on hr.diagnosticGroupId = dg.id
join ageGroups ag on ag.id = hr.ageGroupId
group by dg.description, ag.minimumAge, ag.maximumAge
order by dg.description, ag.minimumAge)

select (minimumAge || ' - ' || maximumAge) as 'AgeRange', description, max(TotalDeaths) as 'TotalDeaths'
from deathsPerGroupAndDoenca
group by AgeRange
order by minimumAge;

--7. doenca mais grave (most deaths) por mes de um dado ano
with allInfoPerMonthYear as (select dg.description, sum(hr.deaths) as 'TotalDeaths', p.month, p.year
from diagnosticGroups dg join healthRegistries hr on dg.id=hr.diagnosticGroupId
join periods p on p.id = hr.periodId
where p.year = ?
group by dg.description, p.month, p.year)

select month, year, description, max(TotalDeaths) as 'TotalDeaths'
from allInfoPerMonthYear
group by month, year
order by month, year;

--8. doenca mais internamentos (most hospitalizations) por mes de um dado ano
with allInfoPerMonthYear as (select dg.description, sum(hr.hospitalizations) as 'TotalHospitalizations', sum(hr.daysofHospitalization) as 'DaysHosp', p.month, p.year
from diagnosticGroups dg join healthRegistries hr on dg.id=hr.diagnosticGroupId
join periods p on p.id = hr.periodId
where p.year = ?
group by dg.description, p.month, p.year)

select  month, year, description, max(TotalHospitalizations) as 'TotalHospitalizations', (DaysHosp * 1.0 / TotalHospitalizations *1.0) as 'AverageTimeInHospitalPerCase'
from allInfoPerMonthYear
group by month, year
order by month, year;

--9. doenca mais grave (most deaths) por mes de um dado ano e de uma dada faixa etaria (age group)
with allInfoPerMonthYear as (select dg.description, sum(hr.deaths) as 'TotalDeaths', p.month, p.year, ag.minimumAge, ag.maximumAge
from diagnosticGroups dg join healthRegistries hr on dg.id=hr.diagnosticGroupId
join periods p on p.id = hr.periodId
join ageGroups ag on ag.id=hr.ageGroupId
where p.year = ? and ag.minimumAge = ?
group by dg.description, p.month, p.year, ag.minimumAge, ag.maximumAge)

select month, year, description, (minimumAge || ' - ' || maximumAge) as 'AgeRange', max(TotalDeaths) as 'TotalDeaths'
from allInfoPerMonthYear
group by month, year
order by month, year;

--10. doenca mais internamentos (most hospitalizations) por mes de um dado ano e de uma dada faixa etaria (age group)
with allInfoPerMonthYear as (select dg.description, sum(hr.hospitalizations) as 'TotalHospitalizations', p.month, p.year, ag.minimumAge, ag.maximumAge, sum(hr.daysofHospitalization) as 'DaysHosp'
from diagnosticGroups dg join healthRegistries hr on dg.id=hr.diagnosticGroupId
join periods p on p.id = hr.periodId
join ageGroups ag on ag.id=hr.ageGroupId
where p.year = ? and ag.minimumAge = ?
group by dg.description, p.month, p.year, ag.minimumAge, ag.maximumAge)

select month, year, description, (minimumAge || ' - ' || maximumAge) as 'AgeRange', max(TotalHospitalizations) as 'TotalHospitalizations', (DaysHosp * 1.0 / TotalHospitalizations *1.0) as 'AverageTimeInHospitalPerCase'
from allInfoPerMonthYear
group by month, year
order by month, year;
