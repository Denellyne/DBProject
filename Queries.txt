------  MAX  --------
--1. Institutions com maior numero de obitos
select i.name, r.name, sum(hr.deaths) as 'TotalDeaths'
from institutions i join regions r on i.regionId = r.id
join healthRegistries hr on hr.institutionId = i.id
group by i.name, r.name
order by sum(hr.deaths) desc; DONE :)

--2. Regions com maior numero de obitos
select r.name, sum(hr.deaths) as 'TotalDeaths'
from institutions i join regions r on i.regionId = r.id
join healthRegistries hr on hr.institutionId = i.id
group by r.name
order by sum(hr.deaths) desc; DONE :)

--3. Institutions com maior numero de internamentos e duracao media de cada internamento
select i.name, r.name, sum(hr.hospitalizations) as 'TotalHospitalizations', ifnull(avg(hr.daysofhospitalization / hr.hospitalizations), 0) as 'AverageHospitalizationTimePerHosp'
from institutions i join regions r on i.regionId = r.id
join healthRegistries hr on hr.institutionId = i.id
group by i.name, r.name
order by TotalHospitalizations desc, AverageHospitalizationTimePerHosp desc;

--4. Diagnostic Groups - total num de internamentos e obitos
select dg.description, sum(hr.hospitalizations) as 'TotalHospitalizationsPerGroup', sum(hr.deaths) as 'TotalDeathsPerGroup'
from diagnosticGroups dg join healthRegistries hr on dg.id=hr.diagnosticgroupId
group by dg.description
order by TotalHospitalizationsPerGroup desc, TotalDeathsPerGroup desc;

--5. morbilidade e mortalidade de cada AgeGroup para cada Diagnostic group
select dg.description, ag.minimumAge, ag.maximumAge, sum(hr.hospitalizations) as 'TotalHospitalizations', sum(hr.deaths) as 'TotalDeaths'
from healthRegistries hr join diagnosticGroups dg on hr.diagnosticGroupId = dg.id
join ageGroups ag on ag.id = hr.ageGroupId
group by dg.description, ag.minimumAge, ag.maximumAge
order by dg.description, ag.minimumAge;

--6. doenca mais grave (most deaths) per age group
with deathsPerGroupAndDoenca as (select dg.description, ag.minimumAge, ag.maximumAge, sum(hr.deaths) as 'TotalDeaths'
from healthRegistries hr join diagnosticGroups dg on hr.diagnosticGroupId = dg.id
join ageGroups ag on ag.id = hr.ageGroupId
group by dg.description, ag.minimumAge, ag.maximumAge
order by dg.description, ag.minimumAge)

select description, minimumAge, maximumAge, max(TotalDeaths) as 'TotalDeaths'
from deathsPerGroupAndDoenca
group by minimumAge, maximumAge
order by TotalDeaths desc

--7. doenca mais grave (most deaths) por mes de um dado ano
with allInfoPerMonthYear as (select dg.description, sum(hr.deaths) as 'TotalDeaths', p.month, p.year
from diagnosticGroups dg join healthRegistries hr on dg.id=hr.diagnosticGroupId
join periods p on p.id = hr.periodId
where p.year = ?
group by dg.description, p.month, p.year)

select description, max(TotalDeaths) as 'TotalDeaths', month, year
from allInfoPerMonthYear
group by month, year
order by month, year;
